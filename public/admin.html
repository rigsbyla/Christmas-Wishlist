<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Wishlist Admin</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background:#f5f5f9; }
    .box { max-width: 720px; margin: 0 auto 18px auto; background: #fff; padding: 18px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.06); }
    h1, h2, h3 { margin-top: 0; }
    input[type=file] { display:block; margin: 12px 0; }
    button { padding: 6px 12px; border-radius: 8px; border: none; background: #2b7cff; color: white; cursor: pointer; font-size: 0.9rem; }
    button:hover { background:#1f63d0; }
    pre { background: #f6f8ff; padding: 10px; border-radius: 6px; overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:0.9rem; }
    th, td { padding:4px 6px; vertical-align:top; }
    thead { background:#fafafa; }
    tr + tr { border-top:1px solid #eee; }
    .edit-btn { background:#5c6bc0; }
    .edit-btn:hover { background:#3f51b5; }
  </style>
</head>
<body>
  <div class="box">
    <h3>Response</h3>
    <pre id="response">No activity yet.</pre>
  </div>


  <div class="box">
    <h2>Admin: People & Preferences</h2>
    <p>View and edit people and their preferences.</p>
    <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center">
      <div>
        <label for="admin-family-select">Family:</label>
        <select id="admin-family-select"></select>
      </div>
      <div style="margin-left:auto">
        <button id="refresh-people" type="button">Refresh people</button>
        <button id="show-add-person" type="button" style="margin-left:8px;background:#28a745">Add Person</button>
      </div>
    </div>
    <div id="people-list">Loading...</div>

    <div id="add-person-area" style="display:none; margin-top:12px">
      <h3>Add Person</h3>
      <form id="add-person-form">
        <div><label>Code: <input id="add-person-code" required style="text-transform:uppercase"/></label></div>
        <div><label>Name: <input id="add-person-name"/></label></div>
        <div><label>Family: <input id="add-person-family" placeholder="default"/></label></div>
        <div><label>Preferences:<br>
          <textarea id="add-person-preferences" rows="3" style="width:100%"></textarea></label>
        </div>
        <div style="margin-top:8px">
          <button type="submit">Add</button>
          <button id="cancel-add-person" type="button" style="background:#aaa">Cancel</button>
        </div>
      </form>
    </div>

    <div id="person-edit-area" style="display:none; margin-top:12px">
      <h3>Edit Person</h3>
      <form id="person-edit-form">
        <input type="hidden" id="person-code" />
        <input type="hidden" id="person-original-family" />
        <div><label>Code: <input id="person-code-display" disabled/></label></div>
        <div><label>Name: <input id="person-name"/></label></div>
        <div><label>Family: <input id="person-family"/></label></div>
        <div><label>Preferences (free text):<br>
          <textarea id="person-preferences" rows="4" style="width:100%"></textarea></label>
        </div>
        <div style="margin-top:8px">
          <button id="save-person" type="submit">Save</button>
          <button id="cancel-person" type="button" style="background:#aaa">Cancel</button>
        </div>
      </form>
    </div>

    
  </div>
  
  <div class="box">
    <h2>Add Wishlist Items</h2>
    <p>Add items via CSV (below) or add a single item one at a time.</p>

    <form id="upload-form">
      <label for="csvfile">CSV file</label>
      <input id="csvfile" name="csvfile" type="file" accept=".csv,text/csv" required />
      <div style="margin-top:10px">
        <button type="submit">Upload CSV</button>
      </div>
    </form>

    <hr />
    <h3>Add Single Item</h3>
    <form id="add-item-form">
      <div><label>Recipient: <select id="add-item-recipient" required></select></label></div>
      <div><label>Item name: <input id="add-item-itemName" style="width:100%" required/></label></div>
      <div><label>Notes / details:<br>
        <textarea id="add-item-details" rows="3" style="width:100%"></textarea></label>
      </div>
      <div><label>URL: <input id="add-item-url" style="width:100%"/></label></div>
      <div><label>Tags (comma separated): <input id="add-item-tags" style="width:100%"/></label></div>
      <div style="margin-top:8px">
        <button type="submit">Add Item</button>
        <button id="cancel-add-item" type="button" style="background:#aaa">Cancel</button>
      </div>
    </form>

  </div>

  <div class="box">
    <h2>Admin: Items</h2>
    <p>View and edit items currently stored in <code>data.json</code>.</p>
    <div id="admin-controls" style="margin-bottom:8px">
      <button id="refresh-items" type="button">Refresh list</button>
    </div>

    <div id="admin-list">Loading...</div>

    <div id="edit-area" style="display:none; margin-top:12px">
      <h3>Edit Item</h3>
      <form id="edit-form">
        <input type="hidden" id="edit-id" />
        <div><label>Recipient code: <input id="edit-recipientCode"/></label></div>
        <div><label>Recipient name: <input id="edit-recipientName"/></label></div>
        <div><label>Item name: <input id="edit-itemName" style="width:100%"/></label></div>
        <div><label>Notes / details:<br>
          <textarea id="edit-details" rows="3" style="width:100%"></textarea></label>
        </div>
        <div><label>URL: <input id="edit-url" style="width:100%"/></label></div>
        <div><label>Tags (comma separated): <input id="edit-tags" style="width:100%"/></label></div>
        <div style="margin-top:8px">
          <button id="save-edit" type="submit">Save</button>
          <button id="cancel-edit" type="button" style="background:#aaa">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Parse response as JSON but fall back to raw text when response is HTML/error page
      async function parseJsonSafe(response) {
        const txt = await response.text();
        try {
          return JSON.parse(txt);
        } catch (err) {
          return { __nonJson: true, status: response.status, raw: txt };
        }
      }

      const form        = document.getElementById('upload-form');
      const resp        = document.getElementById('response');
      const adminListEl = document.getElementById('admin-list');
      const refreshBtn  = document.getElementById('refresh-items');
      const editArea    = document.getElementById('edit-area');
      const editForm    = document.getElementById('edit-form');
      const addItemForm = document.getElementById('add-item-form');

      // --- CSV upload handler ---
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('csvfile');
        if (!fileInput.files || !fileInput.files[0]) {
          resp.textContent = 'Select a file first.';
          return;
        }

        resp.textContent = 'Reading file...';
        const txt = await fileInput.files[0].text();

        resp.textContent = 'Uploading...';

        try {
          const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const r = await fetch('/api/admin/upload-csv-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ csv: txt, family })
          });

          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) {
            resp.textContent = 'Server returned non-JSON response (status ' + json.status + '):\n' + json.raw;
          } else {
            resp.textContent = JSON.stringify(json, null, 2);
          }

          // refresh item list after upload
          loadAdminItems();
        } catch (err) {
          resp.textContent = 'Network error: ' + err.message;
        }
      });

      // --- Add single item handler (construct a one-row CSV and POST to same upload endpoint) ---
      if (addItemForm) {
        addItemForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const recipientSelect = document.getElementById('add-item-recipient');
          const recipientCode = (recipientSelect && recipientSelect.value) ? String(recipientSelect.value).toUpperCase() : '';
          const recipientName = (recipientSelect && recipientSelect.selectedOptions && recipientSelect.selectedOptions[0]) ? (recipientSelect.selectedOptions[0].dataset.name || '') : '';
          const itemName = document.getElementById('add-item-itemName').value||'';
          const details = document.getElementById('add-item-details').value||'';
          const url = document.getElementById('add-item-url').value||'';
          const tags = document.getElementById('add-item-tags').value||'';
          if (!recipientCode || !itemName) return alert('Recipient code and Item name are required');

          // Build CSV with header row matching server expectations
          const header = ['itemId','recipientCode','recipientName','itemName','details','url','tag'];
          function esc(v){ if (v === null || v === undefined) return ''; return '"' + String(v).replace(/"/g,'""') + '"'; }
          const row = [ '', recipientCode, recipientName, itemName, details, url, tags ].map(esc).join(',');
          const csv = header.join(',') + '\n' + row + '\n';

          try {
            const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
            const r = await fetch('/api/admin/upload-csv-text', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ csv: csv, family })
            });
            const json = await parseJsonSafe(r);
            if (json && json.__nonJson) return alert('Server error: ' + json.raw);
            resp.textContent = JSON.stringify(json, null, 2);
            addItemForm.reset();
            loadAdminItems();
          } catch (err) {
            alert('Error adding item: ' + err.message);
          }
        });

        document.getElementById('cancel-add-item').addEventListener('click', () => { addItemForm.reset(); });
      }

      // --- Admin items listing / edit ---

      async function loadAdminItems() {
        adminListEl.textContent = 'Loading...';
        try {
          const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const r = await fetch('/api/admin/items?family=' + encodeURIComponent(family));
          if (!r.ok) {
            adminListEl.textContent = 'Error: ' + r.status + ' ' + r.statusText;
            return;
          }
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) {
            adminListEl.textContent = 'Server error: ' + json.raw;
            return;
          }
          renderAdminList(json.items || []);
        } catch (err) {
          adminListEl.textContent = 'Error loading items: ' + err.message;
        }
      }

      function renderAdminList(items) {
        if (!items || items.length === 0) {
          adminListEl.innerHTML = '<p>No items found.</p>';
          return;
        }

        let html = '<table>';
        html += '<thead><tr>' +
          '<th style="text-align:left">ID</th>' +
          '<th>Recipient</th>' +
          '<th>Item</th>' +
          '<th>Notes</th>' +
          '<th>Tags</th>' +
          '<th></th>' +
          '</tr></thead><tbody>';

        items.forEach(it => {
          const id = it.id ?? it.itemId ?? '';
          const tagsText = Array.isArray(it.tags) ? it.tags.join(',') : (it.tag || '');

          html += '<tr>' +
            '<td>' + id + '</td>' +
            '<td>' + (it.recipientCode || '') + ' / ' + (it.recipientName || '') + '</td>' +
            '<td>' + (it.itemName || '') + '</td>' +
            '<td>' + (it.details || it.notes || '') + '</td>' +
            '<td>' + tagsText + '</td>' +
            '<td>' +
              '<button data-id="' + id + '" class="edit-btn" type="button">Edit</button>' +
              ' <button data-id="' + id + '" class="delete-item-btn" type="button" style="background:#d9534f;margin-left:6px">Delete</button>' +
            '</td>' +
            '</tr>';
        });

        html += '</tbody></table>';
        adminListEl.innerHTML = html;

        Array.from(adminListEl.querySelectorAll('.edit-btn')).forEach(b => {
          b.addEventListener('click', (e) => {
            const id = e.target.getAttribute('data-id');
            openEdit(id);
          });
        });

        Array.from(adminListEl.querySelectorAll('.delete-item-btn')).forEach(b => {
          b.addEventListener('click', async (e) => {
            const id = e.target.getAttribute('data-id');
            if (!confirm('Delete item ' + id + '? This cannot be undone.')) return;
            try {
              const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
              const r = await fetch('/api/admin/item/' + encodeURIComponent(id) + '?family=' + encodeURIComponent(family), { method: 'DELETE' });
              const json = await parseJsonSafe(r);
              if (json && json.__nonJson) {
                return alert('Server error: ' + json.raw);
              }
              if (!json.success) {
                return alert('Delete failed: ' + (json.message || ''));
              }
              // show small confirmation in Response box and refresh list
              const respEl = document.getElementById('response');
              if (respEl) respEl.textContent = 'Deleted item ' + id;
              loadAdminItems();
            } catch (err) {
              alert('Error deleting item: ' + err.message);
            }
          });
        });
      }

      async function openEdit(id) {
        try {
          const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const r = await fetch('/api/admin/items?family=' + encodeURIComponent(family));
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) return alert('Server error: ' + json.raw);
          const items = json.items || [];
          const it = items.find(x => String(x.id) === String(id) || String(x.itemId) === String(id));
          if (!it) {
            alert('Item not found');
            return;
          }

          document.getElementById('edit-id').value            = it.id || it.itemId || '';
          document.getElementById('edit-recipientCode').value = it.recipientCode || '';
          document.getElementById('edit-recipientName').value = it.recipientName || '';
          document.getElementById('edit-itemName').value      = it.itemName || '';
          document.getElementById('edit-details').value       = it.details || it.notes || '';
          document.getElementById('edit-url').value           = it.url || '';
          document.getElementById('edit-tags').value          =
            (Array.isArray(it.tags) ? it.tags.join(',') : (it.tag || ''));

          editArea.style.display = 'block';
          editArea.scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
          alert('Error opening item: ' + err.message);
        }
      }

      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const payload = {
          recipientCode:  document.getElementById('edit-recipientCode').value,
          recipientName:  document.getElementById('edit-recipientName').value,
          itemName:       document.getElementById('edit-itemName').value,
          details:        document.getElementById('edit-details').value,
          url:            document.getElementById('edit-url').value,
          tags:           document.getElementById('edit-tags').value  // comma-separated string
        };

        try {
          const r = await fetch('/api/admin/item/' + encodeURIComponent(id), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) return alert('Server error: ' + json.raw);
          if (!json.success) {
            alert('Save failed: ' + (json.message || ''));
            return;
          }
          resp.textContent = 'Saved item ' + id;
          editArea.style.display = 'none';
          loadAdminItems();
        } catch (err) {
          alert('Error saving: ' + err.message);
        }
      });

      document.getElementById('cancel-edit').addEventListener('click', () => {
        editArea.style.display = 'none';
      });

      refreshBtn.addEventListener('click', loadAdminItems);

      // initial load of items will happen after families are initialized

      // --- People / preferences admin ---
      const peopleListEl = document.getElementById('people-list');
      const refreshPeopleBtn = document.getElementById('refresh-people');
      const showAddPersonBtn = document.getElementById('show-add-person');
      const addPersonArea = document.getElementById('add-person-area');
      const addPersonForm = document.getElementById('add-person-form');
      const cancelAddPersonBtn = document.getElementById('cancel-add-person');
      const personEditArea = document.getElementById('person-edit-area');
      const personEditForm = document.getElementById('person-edit-form');
      const adminFamilySelect = document.getElementById('admin-family-select');

      async function loadAdminFamilies() {
        try {
          const r = await fetch('/api/families');
          const json = await r.json();
          const fams = json.families || ['default'];
          adminFamilySelect.innerHTML = '';
          fams.forEach(f => { const o = document.createElement('option'); o.value = f; o.textContent = f; adminFamilySelect.appendChild(o); });
        } catch (err) {
          console.error('Failed to load families', err);
        }
      }

      // Populate the recipient dropdown used by the add-item form
      async function populateRecipientOptions() {
        try {
          const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const r = await fetch('/api/recipients?code=&family=' + encodeURIComponent(family));
          if (!r.ok) return;
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) return;
          const list = (json.recipients || []);
          const sel = document.getElementById('add-item-recipient');
          const nameInput = document.getElementById('add-item-recipientName');
          if (!sel) return;
          sel.innerHTML = '';
          list.forEach(p => {
            const o = document.createElement('option');
            o.value = p.code || '';
            // show only the person's name in the dropdown to avoid exposing codes
            o.textContent = p.name || p.code || '';
            if (p.name) o.dataset.name = p.name;
            sel.appendChild(o);
          });
          // set first option if present
          if (sel.options.length > 0) sel.selectedIndex = 0;
        } catch (err) {
          console.error('Failed to populate recipients', err);
        }
      }

      async function loadPeople() {
        peopleListEl.textContent = 'Loading...';
        try {
          const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const r = await fetch('/api/recipients?code=&family=' + encodeURIComponent(family));
          if (!r.ok) { peopleListEl.textContent = 'Error: ' + r.status; return; }
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) { peopleListEl.textContent = 'Server error: ' + json.raw; return; }
          renderPeopleList(json.recipients || []);
        } catch (err) {
          peopleListEl.textContent = 'Error loading people: ' + err.message;
        }
      }

      function renderPeopleList(list) {
        if (!list || list.length === 0) { peopleListEl.innerHTML = '<p>No people found.</p>'; return; }
        let html = '<table>';
        html += '<thead><tr><th>Code</th><th>Name</th><th>Preferences</th><th></th></tr></thead><tbody>';
        list.forEach(p => {
          html += '<tr>' +
              '<td>' + (p.code || '') + '</td>' +
              '<td>' + (p.name || '') + '</td>' +
              '<td>' + ((p.preferences && String(p.preferences).substring(0,80)) || '') + '</td>' +
              '<td>' +
                '<button data-code="' + (p.code || '') + '" class="edit-person-btn" type="button">Edit</button>' +
                ' <button data-code="' + (p.code || '') + '" class="delete-person-btn" type="button" style="background:#d9534f;margin-left:6px">Delete</button>' +
                ' <button data-code="' + (p.code || '') + '" data-family="' + (p.family || '') + '" class="copy-link-btn" type="button" style="background:#17a2b8;margin-left:6px">Copy Link</button>' +
              '</td>' +
              '</tr>';
        });
        html += '</tbody></table>';
        peopleListEl.innerHTML = html;
            Array.from(peopleListEl.querySelectorAll('.edit-person-btn')).forEach(b => {
              b.addEventListener('click', (e) => {
                const code = e.target.getAttribute('data-code');
                openPersonEdit(code);
              });
            });

            Array.from(peopleListEl.querySelectorAll('.delete-person-btn')).forEach(b => {
              b.addEventListener('click', async (e) => {
                const code = e.target.getAttribute('data-code');
                if (!confirm('Delete person "' + code + '" and all their items? This cannot be undone.')) return;
                try {
                  const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
                  const r = await fetch('/api/admin/person/' + encodeURIComponent(code) + '?family=' + encodeURIComponent(family), { method: 'DELETE' });
                  const json = await parseJsonSafe(r);
                  if (json && json.__nonJson) return alert('Server error: ' + json.raw);
                  if (!json.success) return alert('Delete failed: ' + (json.message || ''));
                  document.getElementById('response').textContent = 'Deleted person ' + code;
                  loadPeople();
                  loadAdminItems();
                } catch (err) {
                  alert('Error deleting person: ' + err.message);
                }
              });
            });

            // copy link buttons
            Array.from(peopleListEl.querySelectorAll('.copy-link-btn')).forEach(b => {
              b.addEventListener('click', async (e) => {
                const code = e.target.getAttribute('data-code');
                const famAttr = e.target.getAttribute('data-family');
                const family = famAttr && famAttr.trim() ? famAttr : ((adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default');
                const base = window.location.origin;
                const link = base + '/?code=' + encodeURIComponent(code) + '&family=' + encodeURIComponent(family);

                // attempt modern clipboard API first
                try {
                  if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(link);
                  } else {
                    // fallback: textarea + execCommand
                    const ta = document.createElement('textarea');
                    ta.value = link;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                  }

                  const origText = e.target.textContent;
                  e.target.textContent = 'Copied!';
                  setTimeout(() => { e.target.textContent = origText; }, 1600);
                  const respEl = document.getElementById('response');
                  if (respEl) respEl.textContent = 'Copied link for ' + code + ': ' + link;
                } catch (err) {
                  alert('Copy failed: ' + (err && err.message ? err.message : err));
                }
              });
            });
      }

      async function openPersonEdit(code) {
        try {
          const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const r = await fetch('/api/recipients?code=&family=' + encodeURIComponent(family));
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) return alert('Server error: ' + json.raw);
          const list = json.recipients || [];
          const p = list.find(x => String(x.code) === String(code));
          if (!p) return alert('Person not found');

          document.getElementById('person-code').value = p.code || '';
          document.getElementById('person-code-display').value = p.code || '';
          document.getElementById('person-name').value = p.name || '';
          document.getElementById('person-preferences').value = p.preferences || '';
          document.getElementById('person-family').value = p.family || family;
          // store original family for lookup when saving
          document.getElementById('person-original-family').value = p.family || family;

          personEditArea.style.display = 'block';
          personEditArea.scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
          alert('Error opening person: ' + err.message);
        }
      }

      personEditForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('person-code').value;
        const payload = {
          name: document.getElementById('person-name').value,
          preferences: document.getElementById('person-preferences').value
        };

        try {
          const originalFamily = (document.getElementById('person-original-family') && document.getElementById('person-original-family').value) ? document.getElementById('person-original-family').value : ((adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default');
          const newFamily = (document.getElementById('person-family') && document.getElementById('person-family').value.trim()) ? document.getElementById('person-family').value.trim() : ((adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default');
          payload.family = newFamily;
          const r = await fetch('/api/admin/person/' + encodeURIComponent(code) + '?family=' + encodeURIComponent(originalFamily), {
            method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) return alert('Server error: ' + json.raw);
          if (!json.success) return alert('Save failed: ' + (json.message || ''));
          document.getElementById('response').textContent = 'Saved person ' + code;
          personEditArea.style.display = 'none';
          loadPeople();
        } catch (err) {
          alert('Error saving person: ' + err.message);
        }
      });

      document.getElementById('cancel-person').addEventListener('click', () => { personEditArea.style.display = 'none'; });
      refreshPeopleBtn.addEventListener('click', loadPeople);

      // Show add person area
      showAddPersonBtn.addEventListener('click', () => {
        addPersonArea.style.display = addPersonArea.style.display === 'none' ? 'block' : 'none';
        if (addPersonArea.style.display === 'block') {
          // prefill family input with the admin selector value if available
          const fam = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const apf = document.getElementById('add-person-family');
          if (apf) apf.value = fam;
          document.getElementById('add-person-code').focus();
        }
      });

      cancelAddPersonBtn.addEventListener('click', () => { addPersonArea.style.display = 'none'; });

      addPersonForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('add-person-code').value.trim();
        const name = document.getElementById('add-person-name').value.trim();
        const prefs = document.getElementById('add-person-preferences').value;
        if (!code) return alert('Code is required');
        try {
          const family = (adminFamilySelect && adminFamilySelect.value) ? adminFamilySelect.value : 'default';
          const r = await fetch('/api/admin/person', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ code: code.toUpperCase(), name, preferences: prefs, family })
          });
          const json = await parseJsonSafe(r);
          if (json && json.__nonJson) return alert('Server error: ' + json.raw);
          if (!json.success) return alert('Add failed: ' + (json.message || ''));
          document.getElementById('response').textContent = 'Added person ' + code.toUpperCase();
          addPersonArea.style.display = 'none';
          addPersonForm.reset();
          loadPeople();
        } catch (err) {
          alert('Error adding person: ' + err.message);
        }
      });
      // initial load: families then people and items
      await loadAdminFamilies();
      if (adminFamilySelect) {
        adminFamilySelect.addEventListener('change', () => { loadPeople(); loadAdminItems(); populateRecipientOptions(); });
      }
      await populateRecipientOptions();
      loadPeople();
      loadAdminItems();
    });
  </script>
</body>
</html>
